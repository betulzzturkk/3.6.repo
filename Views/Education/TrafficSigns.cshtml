@{
    ViewData["Title"] = "Trafik İşaretleri";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="/Education" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Geri Dön
        </a>
        <h2 class="text-center mb-0">Trafik İşaretleri</h2>
        <div style="width: 100px;"></div>
    </div>

    <div class="container py-5">
        <div class="row mb-4">
            <div class="col text-center">
                <h1 class="display-4">Trafik Levhaları</h1>
                <p class="lead text-muted">Trafik levhalarını tanıyalım ve öğrenelim</p>
            </div>
        </div>

        @if (User?.Identity?.IsAuthenticated == true)
        {
            <div class="row mb-4">
                <div class="col">
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-success progress-bar-striped" id="moduleProgress" 
                             role="progressbar" style="width: 0%;" 
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row mb-4">
                <div class="col">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i>
                        İlerlemenizin kaydedilmesi için <a href="/Account/Login" class="alert-link">giriş yapın</a> veya 
                        <a href="/Account/Register" class="alert-link">kayıt olun</a>.
                    </div>
                </div>
            </div>
        }

        <div class="row g-4" id="signCards">
            <!-- Dur -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="dur">
                    <img src="~/images/dur.png" class="card-img-top" alt="Dur İşareti" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Dur</h5>
                        <p class="card-text text-muted small mb-3">Dur işareti, aracın tamamen durmasını gerektirir</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('dur')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Yaya Geçidi -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="yaya-gecidi">
                    <img src="~/images/yaya-gecidi.jpg" class="card-img-top" alt="Yaya Geçidi" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Yaya Geçidi</h5>
                        <p class="card-text text-muted small mb-3">Yayaların karşıdan karşıya geçtiği yer</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('yaya-gecidi')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Park Yasak -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="park-yasak">
                    <img src="~/images/park-yasak.jpg" class="card-img-top" alt="Park Yasak" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Park Yasak</h5>
                        <p class="card-text text-muted small mb-3">Araç park edilmesi yasak olan bölge</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('park-yasak')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Okul Geçidi -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="okul-gecidi">
                    <img src="~/images/okul-gecidi.jpg" class="card-img-top" alt="Okul Geçidi" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Okul Geçidi</h5>
                        <p class="card-text text-muted small mb-3">Okul yakınında, öğrencilerin geçiş yaptığı yer</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('okul-gecidi')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Hız Limiti -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="hiz-limiti">
                    <img src="~/images/hiz-limiti.jpg" class="card-img-top" alt="Hız Limiti" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Hız Limiti</h5>
                        <p class="card-text text-muted small mb-3">Araçların uyması gereken hız sınırı</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('hiz-limiti')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Girilmez -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="girilmez">
                    <img src="~/images/girilmez.jpg" class="card-img-top" alt="Girilmez" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Girilmez</h5>
                        <p class="card-text text-muted small mb-3">Bu yöne araç girişi yasaktır</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('girilmez')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Sağa Dön -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="saga-don">
                    <img src="~/images/saga-don.jpg" class="card-img-top" alt="Sağa Dön" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Sağa Dön</h5>
                        <p class="card-text text-muted small mb-3">Araçların sağa dönmesi gereken yer</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('saga-don')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Sola Dön -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="sola-don">
                    <img src="~/images/sola-don.jpg" class="card-img-top" alt="Sola Dön" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Sola Dön</h5>
                        <p class="card-text text-muted small mb-3">Araçların sola dönmesi gereken yer</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('sola-don')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Hastane -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="hastane">
                    <img src="~/images/hastane.jpg" class="card-img-top" alt="Hastane" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Hastane</h5>
                        <p class="card-text text-muted small mb-3">Hastane bölgesi, dikkatli ve sessiz olunmalı</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('hastane')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Işıklı İşaret -->
            <div class="col-md-3 col-sm-6">
                <div class="card h-100 sign-card" data-sign="isikli-isaret">
                    <img src="~/images/isikli-isaret.jpg" class="card-img-top" alt="Işıklı İşaret" style="height: 200px; object-fit: contain;">
                    <div class="card-body text-center">
                        <h5 class="card-title">Işıklı İşaret</h5>
                        <p class="card-text text-muted small mb-3">Trafik ışıkları ile kontrollü geçiş</p>
                        <button class="btn btn-primary play-sound" onclick="playSignSound('isikli-isaret')">
                            <i class="fas fa-volume-up"></i> Sesi Çal
                        </button>
                        @if (User?.Identity?.IsAuthenticated == true)
                        {
                            <div class="mt-2">
                                <i class="fas fa-check-circle text-success completion-icon" style="display: none;"></i>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }

    .card-title {
        color: #dc3545;
        font-weight: 600;
    }

    .card-text {
        color: #6c757d;
    }

    .btn-primary {
        background-color: #3498db;
        border-color: #3498db;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #2980b9;
        border-color: #2980b9;
        transform: translateX(-5px);
    }
</style>

@section Scripts {
    <script>
        function playSignSound(sign) {
            const audio = new Audio(`/sounds/traffic-signs/${sign}.mp3`);
            
            audio.onended = function() {
                if (@Json.Serialize(User?.Identity?.IsAuthenticated == true)) {
                    markAsCompleted(sign);
                }
            };
            
            audio.play();
        }

        function markAsCompleted(sign) {
            const card = document.querySelector(`[data-sign="${sign}"]`);
            const icon = card.querySelector('.completion-icon');
            icon.style.display = 'inline-block';

            saveProgress(sign);
            updateProgress();
        }

        function saveProgress(sign) {
            fetch('/Education/SaveProgress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    moduleName: 'TrafficSigns',
                    itemName: sign,
                    isCompleted: true
                })
            });
        }

        function updateProgress() {
            const totalSigns = document.querySelectorAll('.sign-card').length;
            const completedSigns = document.querySelectorAll('.completion-icon[style="display: inline-block"]').length;
            const progressPercentage = (completedSigns / totalSigns) * 100;

            const progressBar = document.getElementById('moduleProgress');
            if (progressBar) {
                progressBar.style.width = `${progressPercentage}%`;
                progressBar.textContent = `${Math.round(progressPercentage)}%`;
                progressBar.setAttribute('aria-valuenow', progressPercentage);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (@Json.Serialize(User?.Identity?.IsAuthenticated == true)) {
                fetch('/Education/GetProgress?moduleName=TrafficSigns')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(item => {
                            if (item.isCompleted) {
                                const card = document.querySelector(`[data-sign="${item.itemName}"]`);
                                if (card) {
                                    const icon = card.querySelector('.completion-icon');
                                    icon.style.display = 'inline-block';
                                }
                            }
                        });
                        updateProgress();
                    });
            }
        });
    </script>
}